{"version":3,"file":"risk.js","sources":["utils/risk.js"],"sourcesContent":["// utils/risk.js\n\n/**\n * ATR 驱动 + 风控版仓位计算\n *\n * 已知：\n * - equity: 总本金（U）\n * - riskPercent: 单笔风险占比（%）\n * - leverage: 杠杆倍数\n * - entryPrice: 开仓价\n * - stopLossPrice: 止损价（由 ATR 决定）\n *\n * 返回：\n * - 风险金额、止损距离、名义仓位、数量等\n */\nexport function calcPositionSize({ equity, riskPercent, leverage, entryPrice, stopLossPrice }) {\n    if (\n        !equity ||\n        equity <= 0 ||\n        !riskPercent ||\n        riskPercent <= 0 ||\n        !leverage ||\n        leverage <= 0 ||\n        !entryPrice ||\n        entryPrice <= 0 ||\n        !stopLossPrice ||\n        stopLossPrice <= 0\n    ) {\n        return null;\n    }\n\n    const stopDistance = Math.abs(entryPrice - stopLossPrice);\n    if (stopDistance <= 0) {\n        return null;\n    }\n\n    // 允许亏损金额 = 本金 × 单笔风险%\n    const riskAmount = equity * (riskPercent / 100);\n\n    // 由风险和止损距离推导出的名义仓位\n    // 推导：亏损金额 = 仓位名义 × (止损距离 / 开仓价)\n    // => 仓位名义 = 亏损金额 × 开仓价 / 止损距离\n    const notionalByRisk = (riskAmount * entryPrice) / stopDistance;\n\n    // 杠杆上限允许的最大名义金额\n    const maxNotionalByLev = equity * leverage;\n\n    // 实际可用名义仓位（同时满足风控与杠杆）\n    const finalNotional = Math.min(notionalByRisk, maxNotionalByLev);\n\n    const qty = finalNotional / entryPrice;\n\n    return {\n        riskAmount,        // 允许亏损金额\n        stopDistance,      // 止损距离\n        notionalByRisk,    // 风控导出的名义仓位\n        maxNotionalByLev,  // 杠杆允许的上限\n        finalNotional,     // 实际使用的名义仓位\n        qty                // 建议数量（币）\n    };\n}"],"names":[],"mappings":";AAeO,SAAS,iBAAiB,EAAE,QAAQ,aAAa,UAAU,YAAY,iBAAiB;AAC3F,MACI,CAAC,UACD,UAAU,KACV,CAAC,eACD,eAAe,KACf,CAAC,YACD,YAAY,KACZ,CAAC,cACD,cAAc,KACd,CAAC,iBACD,iBAAiB,GACnB;AACE,WAAO;AAAA,EACV;AAED,QAAM,eAAe,KAAK,IAAI,aAAa,aAAa;AACxD,MAAI,gBAAgB,GAAG;AACnB,WAAO;AAAA,EACV;AAGD,QAAM,aAAa,UAAU,cAAc;AAK3C,QAAM,iBAAkB,aAAa,aAAc;AAGnD,QAAM,mBAAmB,SAAS;AAGlC,QAAM,gBAAgB,KAAK,IAAI,gBAAgB,gBAAgB;AAE/D,QAAM,MAAM,gBAAgB;AAE5B,SAAO;AAAA,IACH;AAAA;AAAA,IACA;AAAA;AAAA,IACA;AAAA;AAAA,IACA;AAAA;AAAA,IACA;AAAA;AAAA,IACA;AAAA;AAAA,EACR;AACA;;"}