{"version":3,"file":"index.js","sources":["pages/index/index.vue","pages/index/index.vue?type=page"],"sourcesContent":["<template>\n    <view class=\"container\">\n        <!-- 交易对选择 -->\n        <UiSection label=\"交易对\">\n            <picker mode=\"selector\" :range=\"symbolOptions\" @change=\"onSymbolSelect\">\n                <view class=\"picker\">当前：{{ symbol }}</view>\n            </picker>\n        </UiSection>\n\n        <!-- 最新价格 -->\n        <UiSection label=\"最新价格\">\n            <view class=\"price-grid\">\n                <view class=\"price-item price-row-bg\">\n                    <view class=\"price-title\">现货</view>\n                    <view class=\"price-value\">{{ spotPrice || '-' }}</view>\n                </view>\n\n                <view class=\"price-item price-row-bg\">\n                    <view class=\"price-title\">合约</view>\n                    <view class=\"price-value\">{{ futuresPrice || '-' }}</view>\n                </view>\n\n                <view class=\"price-item price-row-bg\">\n                    <view class=\"price-title\">合约 - 现货</view>\n                    <view :class=\"'price-value ' + (priceDiff === null ? '' : priceDiff >= 0 ? 'price-up' : 'price-down')\">\n                        {{ priceDiff === null ? '-' : priceDiff }}\n                    </view>\n                </view>\n            </view>\n\n            <view class=\"price-actions\">\n                <button class=\"mini-btn\" size=\"mini\" @tap=\"refreshPrices\">刷新价格</button>\n            </view>\n        </UiSection>\n\n        <!-- K线周期（ATR 使用此周期） -->\n        <UiSection label=\"K线周期（ATR 使用此周期）\">\n            <picker mode=\"selector\" :range=\"intervalOptions\" @change=\"onIntervalSelect\">\n                <view class=\"picker\">当前：{{ interval }}</view>\n            </picker>\n        </UiSection>\n\n        <!-- ATR 周期 -->\n        <UiSection label=\"ATR 周期\">\n            <input type=\"number\" :value=\"atrPeriodInput\" placeholder=\"14\" @input=\"onAtrPeriodInput\" />\n        </UiSection>\n\n        <!-- ATR 倍数 -->\n        <UiSection label=\"ATR 倍数（例如 1.5）\">\n            <input type=\"digit\" :value=\"atrMultInput\" placeholder=\"1.5\" @input=\"onAtrMultInput\" />\n        </UiSection>\n\n        <!-- 风控参数 -->\n        <UiSection label=\"风控参数\">\n            <view>\n                <view class=\"sub-label\">总本金（U）</view>\n                <input type=\"digit\" :value=\"equityInput\" placeholder=\"例如 500\" @input=\"onEquityInput\" />\n\n                <view class=\"sub-label\">单笔风险（%）</view>\n                <input type=\"digit\" :value=\"riskPercentInput\" placeholder=\"例如 1 或 2\" @input=\"onRiskPercentInput\" />\n\n                <view class=\"sub-label\">杠杆倍数</view>\n                <input type=\"digit\" :value=\"leverageInput\" placeholder=\"例如 3 或 5\" @input=\"onLeverageInput\" />\n            </view>\n        </UiSection>\n\n        <!-- 开仓方向 -->\n        <UiSection label=\"开仓方向\">\n            <picker mode=\"selector\" :range=\"directionOptions\" @change=\"onDirectionChange\">\n                <view class=\"picker\">当前：{{ direction === 'long' ? '多单' : '空单' }}</view>\n            </picker>\n        </UiSection>\n\n        <!-- 开仓价 -->\n        <UiSection label=\"开仓价（Entry Price）\">\n            <input type=\"digit\" :value=\"entryPriceInput\" placeholder=\"请输入手动开仓价\" @input=\"onEntryPriceInput\" />\n        </UiSection>\n\n        <!-- 计算按钮 -->\n        <UiButton text=\"计算 ATR、止损与仓位建议\" :loading=\"loading\" @tap.native=\"onCalcTap\" />\n\n        <!-- 结果卡片：交易计划 -->\n        <UiResultCard\n            :symbol=\"symbol\"\n            :interval=\"interval\"\n            :direction=\"direction\"\n            :atr=\"atr\"\n            :atrPeriodInput=\"atrPeriodInput\"\n            :entryPriceInput=\"entryPriceInput\"\n            :stopLossPrice=\"stopLossPrice\"\n            :riskPercentInput=\"riskPercentInput\"\n            :riskAmount=\"riskAmount\"\n            :stopDistance=\"stopDistance\"\n            :positionNotional=\"positionNotional\"\n            :positionQty=\"positionQty\"\n            :rrRatio=\"rrRatio\"\n        />\n\n        <!-- 错误提示 -->\n        <view class=\"error\" v-if=\"error\">\n            {{ error }}\n        </view>\n    </view>\n</template>\n\n<script>\nimport UiSection from '@/components/ui-section/ui-section.vue';\nimport UiButton from '@/components/ui-button/ui-button.vue';\nimport UiResultCard from '@/components/ui-result-card/ui-result-card.vue';\n\n// ====== 把 require 全部换成 import ======\nimport { calcATR } from '@/utils/atr.js';\nimport { fetchCandlesFromBinance, fetchSpotPrice, fetchFuturesPrice } from '@/utils/binanceApi.js';\nimport { SYMBOL_OPTIONS, INTERVAL_OPTIONS } from '@/config/trading.js';\nimport { calcPositionSize } from '@/utils/risk.js';\n\nexport default {\n    components: {\n        UiSection,\n        UiButton,\n        UiResultCard\n    },\n    data() {\n        return {\n            // ▼ 交易对列表 & 当前选择\n            symbolOptions: SYMBOL_OPTIONS,\n            symbol: 'BTCUSDT',\n\n            // ▼ K线周期列表（用于 ATR）\n            intervalOptions: INTERVAL_OPTIONS,\n            interval: '1h',\n\n            // ▼ ATR 输入\n            atrPeriodInput: '14',\n            atrMultInput: '1.5',\n\n            // ▼ 风控输入\n            equityInput: '',\n            riskPercentInput: '',\n            leverageInput: '',\n\n            // ▼ 开仓 & 方向\n            entryPriceInput: '',\n            directionOptions: ['多单', '空单'],\n            direction: 'long',\n\n            // ▼ 最新价格\n            spotPrice: null,\n            futuresPrice: null,\n            priceDiff: null,\n\n            // ▼ 计算结果\n            loading: false,\n            atr: null,\n            stopLossPrice: null,\n            error: '',\n            rrRatio: null,\n\n            riskAmount: null,\n            stopDistance: null,\n            positionNotional: null,\n            positionQty: null\n        };\n    },\n    onLoad() {\n        this.refreshPrices();\n    },\n    methods: {\n        // ====== 下拉选择 ======\n        onSymbolSelect(e) {\n            const idx = Number(e.detail.value);\n            this.setData(\n                {\n                    symbol: this.symbolOptions[idx]\n                },\n                () => this.refreshPrices()\n            );\n        },\n\n        onIntervalSelect(e) {\n            const idx = Number(e.detail.value);\n            this.setData({\n                interval: this.intervalOptions[idx]\n            });\n        },\n\n        onDirectionChange(e) {\n            const idx = Number(e.detail.value);\n            this.setData({\n                direction: idx === 0 ? 'long' : 'short'\n            });\n        },\n\n        // ====== 输入处理 ======\n        onAtrPeriodInput(e) {\n            this.setData({ atrPeriodInput: e.detail.value });\n        },\n        onAtrMultInput(e) {\n            this.setData({ atrMultInput: e.detail.value });\n        },\n        onEquityInput(e) {\n            this.setData({ equityInput: e.detail.value });\n        },\n        onRiskPercentInput(e) {\n            this.setData({ riskPercentInput: e.detail.value });\n        },\n        onLeverageInput(e) {\n            this.setData({ leverageInput: e.detail.value });\n        },\n        onEntryPriceInput(e) {\n            this.setData({ entryPriceInput: e.detail.value });\n        },\n\n        // ====== 刷新价格 ======\n        refreshPrices() {\n            const { symbol } = this;\n\n            this.setData({\n                spotPrice: null,\n                futuresPrice: null,\n                priceDiff: null\n            });\n\n            Promise.all([fetchSpotPrice(symbol), fetchFuturesPrice(symbol)])\n                .then(([spot, fut]) => {\n                    const diff = fut - spot;\n                    this.setData({\n                        spotPrice: spot.toFixed(2),\n                        futuresPrice: fut.toFixed(2),\n                        priceDiff: diff.toFixed(2)\n                    });\n                })\n                .catch((err) => {\n                    console.error('刷新价格失败', err);\n                    this.setData({\n                        error: '刷新现货/合约价格失败（请检查合法域名配置）'\n                    });\n                });\n        },\n\n        // ====== 核心逻辑：ATR + 止损 + 仓位 ======\n        onCalcTap() {\n            const {\n                atrPeriodInput,\n                atrMultInput,\n                entryPriceInput,\n                direction,\n                symbol,\n                interval,\n                equityInput,\n                riskPercentInput,\n                leverageInput\n            } = this;\n\n            // 解析数字\n            const atrPeriod = parseInt(atrPeriodInput, 10);\n            const atrMult = parseFloat(atrMultInput);\n            const entryPrice = parseFloat(entryPriceInput);\n            const equity = parseFloat(equityInput);\n            const riskPercent = parseFloat(riskPercentInput);\n            const leverage = parseFloat(leverageInput);\n\n            // 基础校验：先保证 ATR 与止损能算\n            if (!entryPrice || entryPrice <= 0) {\n                this._error('开仓价无效，请输入开仓价');\n                return;\n            }\n            if (!atrPeriod || atrPeriod <= 0) {\n                this._error('ATR 周期无效，请输入大于 0 的整数');\n                return;\n            }\n            if (!atrMult || atrMult <= 0) {\n                this._error('ATR 倍数无效，请输入大于 0 的数字');\n                return;\n            }\n\n            this.setData({\n                loading: true,\n                error: '',\n                atr: null,\n                stopLossPrice: null,\n                riskAmount: null,\n                stopDistance: null,\n                positionNotional: null,\n                positionQty: null,\n                rrRatio: null\n            });\n\n            // 请求 K 线计算 ATR\n            fetchCandlesFromBinance(symbol, interval, 200)\n                .then((candles) => {\n                    const atr = calcATR(candles, atrPeriod);\n                    if (!atr) {\n                        this._error('K线数量不足，无法计算 ATR');\n                        return;\n                    }\n\n                    // 止损价\n                    const stopLossPrice =\n                        direction === 'long'\n                            ? entryPrice - atrMult * atr\n                            : entryPrice + atrMult * atr;\n\n                    // 风险点差\n                    const riskDistance =\n                        direction === 'long'\n                            ? entryPrice - stopLossPrice\n                            : stopLossPrice - entryPrice;\n\n                    // RR\n                    const rrText = `1 : ${atrMult.toFixed(2)}`;\n\n                    const baseResult = {\n                        loading: false,\n                        atr: atr.toFixed(2),\n                        stopLossPrice: stopLossPrice.toFixed(2),\n                        stopDistance: riskDistance.toFixed(2),\n                        rrRatio: rrText\n                    };\n\n                    // 风控参数完整 → 计算仓位\n                    if (\n                        equity > 0 &&\n                        riskPercent > 0 &&\n                        leverage > 0\n                    ) {\n                        const pos = calcPositionSize({\n                            equity,\n                            riskPercent,\n                            leverage,\n                            entryPrice,\n                            stopLossPrice\n                        });\n\n                        if (pos) {\n                            this.setData({\n                                ...baseResult,\n                                riskAmount: pos.riskAmount.toFixed(2),\n                                positionNotional: pos.finalNotional.toFixed(2),\n                                positionQty: pos.qty.toFixed(4)\n                            });\n                            return;\n                        }\n                    }\n\n                    // 风控不完整，只显示基础\n                    this.setData(baseResult);\n                })\n                .catch((err) => {\n                    console.error('请求K线失败', err);\n                    this._error('请求现货K线失败（请确认 api.binance.com 合法域名已配置）');\n                });\n        },\n\n        // ====== 通用错误处理 ======\n        _error(msg) {\n            this.setData({\n                loading: false,\n                error: msg,\n                atr: null,\n                stopLossPrice: null,\n                riskAmount: null,\n                stopDistance: null,\n                positionNotional: null,\n                positionQty: null,\n                rrRatio: null\n            });\n        }\n    }\n};\n</script>\n<style>\n/* 可以加一点页面级的小调整 */\n.container {\n    /* 可选：稍微窄一点，看起来更像工具面板 */\n    max-width: 680rpx;\n    margin: 0 auto;\n}\n\n/* 给结果卡片一点额外的间距，方便观察 */\n.result-card-wrapper {\n    margin-top: 24rpx;\n}\n</style>\n","import MiniProgramPage from '/Users/quanshunzhi/WeChatProjects/atr-risk-miniapp_uni/pages/index/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["SYMBOL_OPTIONS","INTERVAL_OPTIONS","fetchSpotPrice","fetchFuturesPrice","uni","fetchCandlesFromBinance","calcATR","calcPositionSize"],"mappings":"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"}