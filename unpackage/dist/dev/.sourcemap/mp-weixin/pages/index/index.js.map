{"version":3,"file":"index.js","sources":["pages/index/index.vue","pages/index/index.vue?type=page"],"sourcesContent":["<template>\n    <view class=\"container\">\n        <!-- 交易对选择 -->\n        <UiSection label=\"交易对\">\n            <picker mode=\"selector\" :range=\"symbolOptions\" @change=\"onSymbolSelect\">\n                <view class=\"picker\">当前：{{ symbol }}</view>\n            </picker>\n        </UiSection>\n\n        <!-- 最新价格 -->\n        <UiSection label=\"最新价格\">\n            <view class=\"price-grid\">\n                <view class=\"price-item price-row-bg\">\n                    <view class=\"price-title\">现货</view>\n                    <view class=\"price-value\">{{ spotPrice || '-' }}</view>\n                </view>\n\n                <view class=\"price-item price-row-bg\">\n                    <view class=\"price-title\">合约</view>\n                    <view class=\"price-value\">{{ futuresPrice || '-' }}</view>\n                </view>\n\n                <view class=\"price-item price-row-bg\">\n                    <view class=\"price-title\">合约 - 现货</view>\n                    <view :class=\"'price-value ' + (priceDiff === null ? '' : priceDiff >= 0 ? 'price-up' : 'price-down')\">\n                        {{ priceDiff === null ? '-' : priceDiff }}\n                    </view>\n                </view>\n            </view>\n\n            <view class=\"price-actions\">\n                <button class=\"mini-btn\" size=\"mini\" @tap=\"refreshPrices\">刷新价格</button>\n            </view>\n        </UiSection>\n\n        <!-- K线周期（ATR 使用此周期） -->\n        <UiSection label=\"K线周期（ATR 使用此周期）\">\n            <picker mode=\"selector\" :range=\"intervalOptions\" @change=\"onIntervalSelect\">\n                <view class=\"picker\">当前：{{ interval }}</view>\n            </picker>\n        </UiSection>\n\n        <!-- ATR 周期 -->\n        <UiSection label=\"ATR 周期\">\n            <input type=\"number\" :value=\"atrPeriodInput\" placeholder=\"14\" @input=\"onAtrPeriodInput\" />\n        </UiSection>\n\n        <!-- ATR 倍数 -->\n        <UiSection label=\"ATR 倍数（例如 1.5）\">\n            <input type=\"digit\" :value=\"atrMultInput\" placeholder=\"1.5\" @input=\"onAtrMultInput\" />\n        </UiSection>\n\n        <!-- 风控参数 -->\n        <UiSection label=\"风控参数\">\n            <view>\n                <view class=\"sub-label\">总本金（U）</view>\n                <input type=\"digit\" :value=\"equityInput\" placeholder=\"例如 500\" @input=\"onEquityInput\" />\n\n                <view class=\"sub-label\">单笔风险（%）</view>\n                <input type=\"digit\" :value=\"riskPercentInput\" placeholder=\"例如 1 或 2\" @input=\"onRiskPercentInput\" />\n\n                <view class=\"sub-label\">杠杆倍数</view>\n                <input type=\"digit\" :value=\"leverageInput\" placeholder=\"例如 3 或 5\" @input=\"onLeverageInput\" />\n            </view>\n        </UiSection>\n\n        <!-- 开仓方向 -->\n        <UiSection label=\"开仓方向\">\n            <picker mode=\"selector\" :range=\"directionOptions\" @change=\"onDirectionChange\">\n                <view class=\"picker\">当前：{{ direction === 'long' ? '多单' : '空单' }}</view>\n            </picker>\n        </UiSection>\n\n        <!-- 开仓价 -->\n        <UiSection label=\"开仓价（Entry Price）\">\n            <input type=\"digit\" :value=\"entryPriceInput\" placeholder=\"请输入手动开仓价\" @input=\"onEntryPriceInput\" />\n        </UiSection>\n\n        <!-- 计算按钮 -->\n        <UiButton text=\"计算 ATR、止损与仓位建议\" :loading=\"loading\" @tap=\"onCalcTap\" />\n\n        <!-- 结果卡片：交易计划 -->\n        <UiResultCard\n            :symbol=\"symbol\"\n            :interval=\"interval\"\n            :direction=\"direction\"\n            :atr=\"atr\"\n            :atrPeriodInput=\"atrPeriodInput\"\n            :entryPriceInput=\"entryPriceInput\"\n            :stopLossPrice=\"stopLossPrice\"\n            :riskPercentInput=\"riskPercentInput\"\n            :riskAmount=\"riskAmount\"\n            :stopDistance=\"stopDistance\"\n            :positionNotional=\"positionNotional\"\n            :positionQty=\"positionQty\"\n            :rrRatio=\"rrRatio\"\n        />\n\n        <!-- 错误提示 -->\n        <view class=\"error\" v-if=\"error\">\n            {{ error }}\n        </view>\n    </view>\n</template>\n\n<script setup>\nimport { reactive, toRefs } from 'vue';\nimport { onLoad } from '@dcloudio/uni-app';\n\nimport UiSection from '@/components/ui-section/ui-section.vue';\nimport UiButton from '@/components/ui-button/ui-button.vue';\nimport UiResultCard from '@/components/ui-result-card/ui-result-card.vue';\n\nimport { calcATR } from '@/utils/atr.js';\nimport { fetchCandlesFromBinance, fetchSpotPrice, fetchFuturesPrice } from '@/utils/binanceApi.js';\nimport { SYMBOL_OPTIONS, INTERVAL_OPTIONS } from '@/config/trading.js';\nimport { calcPositionSize } from '@/utils/risk.js';\n\nconst state = reactive({\n    // ▼ 交易对列表 & 当前选择\n    symbolOptions: SYMBOL_OPTIONS,\n    symbol: 'BTCUSDT',\n\n    // ▼ K线周期列表（用于 ATR）\n    intervalOptions: INTERVAL_OPTIONS,\n    interval: '1h',\n\n    // ▼ ATR 输入\n    atrPeriodInput: '14',\n    atrMultInput: '1.5',\n\n    // ▼ 风控输入\n    equityInput: '',\n    riskPercentInput: '',\n    leverageInput: '',\n\n    // ▼ 开仓 & 方向\n    entryPriceInput: '',\n    directionOptions: ['多单', '空单'],\n    direction: 'long',\n\n    // ▼ 最新价格\n    spotPrice: null,\n    futuresPrice: null,\n    priceDiff: null,\n\n    // ▼ 计算结果\n    loading: false,\n    atr: null,\n    stopLossPrice: null,\n    error: '',\n    rrRatio: null,\n\n    riskAmount: null,\n    stopDistance: null,\n    positionNotional: null,\n    positionQty: null\n});\n\nconst setResultState = (overrides = {}) => {\n    Object.assign(state, {\n        loading: false,\n        error: '',\n        atr: null,\n        stopLossPrice: null,\n        riskAmount: null,\n        stopDistance: null,\n        positionNotional: null,\n        positionQty: null,\n        rrRatio: null,\n        ...overrides\n    });\n};\n\nconst setError = (msg) => {\n    setResultState({\n        error: msg\n    });\n};\n\n// ====== 下拉选择 ======\nconst onSymbolSelect = (e) => {\n    const idx = Number(e.detail.value);\n    const selected = state.symbolOptions[idx];\n    if (!selected) {\n        return;\n    }\n    state.symbol = selected;\n    refreshPrices();\n};\n\nconst onIntervalSelect = (e) => {\n    const idx = Number(e.detail.value);\n    const selected = state.intervalOptions[idx];\n    if (selected) {\n        state.interval = selected;\n    }\n};\n\nconst onDirectionChange = (e) => {\n    const idx = Number(e.detail.value);\n    state.direction = idx === 0 ? 'long' : 'short';\n};\n\n// ====== 输入处理 ======\nconst onAtrPeriodInput = (e) => {\n    state.atrPeriodInput = e.detail.value;\n};\nconst onAtrMultInput = (e) => {\n    state.atrMultInput = e.detail.value;\n};\nconst onEquityInput = (e) => {\n    state.equityInput = e.detail.value;\n};\nconst onRiskPercentInput = (e) => {\n    state.riskPercentInput = e.detail.value;\n};\nconst onLeverageInput = (e) => {\n    state.leverageInput = e.detail.value;\n};\nconst onEntryPriceInput = (e) => {\n    state.entryPriceInput = e.detail.value;\n};\n\n// ====== 刷新价格 ======\nconst refreshPrices = async () => {\n    const symbol = state.symbol;\n\n    state.spotPrice = null;\n    state.futuresPrice = null;\n    state.priceDiff = null;\n\n    try {\n        const [spot, fut] = await Promise.all([fetchSpotPrice(symbol), fetchFuturesPrice(symbol)]);\n        const diff = fut - spot;\n        state.spotPrice = spot.toFixed(2);\n        state.futuresPrice = fut.toFixed(2);\n        state.priceDiff = diff.toFixed(2);\n        state.error = '';\n    } catch (err) {\n        console.error('刷新价格失败', err);\n        state.error = '刷新现货/合约价格失败（请检查合法域名配置）';\n    }\n};\n\n// ====== 核心逻辑：ATR + 止损 + 仓位 ======\nconst onCalcTap = async () => {\n    const {\n        atrPeriodInput,\n        atrMultInput,\n        entryPriceInput,\n        direction,\n        symbol,\n        interval,\n        equityInput,\n        riskPercentInput,\n        leverageInput\n    } = state;\n\n    // 解析数字\n    const atrPeriod = parseInt(atrPeriodInput, 10);\n    const atrMult = parseFloat(atrMultInput);\n    const entryPrice = parseFloat(entryPriceInput);\n    const equity = parseFloat(equityInput);\n    const riskPercent = parseFloat(riskPercentInput);\n    const leverage = parseFloat(leverageInput);\n\n    // 基础校验：先保证 ATR 与止损能算\n    if (!entryPrice || entryPrice <= 0) {\n        setError('开仓价无效，请输入开仓价');\n        return;\n    }\n    if (!atrPeriod || atrPeriod <= 0) {\n        setError('ATR 周期无效，请输入大于 0 的整数');\n        return;\n    }\n    if (!atrMult || atrMult <= 0) {\n        setError('ATR 倍数无效，请输入大于 0 的数字');\n        return;\n    }\n\n    setResultState({\n        loading: true\n    });\n\n    try {\n        const candles = await fetchCandlesFromBinance(symbol, interval, 200);\n        const atr = calcATR(candles, atrPeriod);\n        if (!atr) {\n            setError('K线数量不足，无法计算 ATR');\n            return;\n        }\n\n        const stopLossPrice =\n            direction === 'long' ? entryPrice - atrMult * atr : entryPrice + atrMult * atr;\n\n        const riskDistance =\n            direction === 'long' ? entryPrice - stopLossPrice : stopLossPrice - entryPrice;\n\n        const rrText = `1 : ${atrMult.toFixed(2)}`;\n\n        const baseResult = {\n            loading: false,\n            atr: atr.toFixed(2),\n            stopLossPrice: stopLossPrice.toFixed(2),\n            stopDistance: riskDistance.toFixed(2),\n            rrRatio: rrText\n        };\n\n        if (equity > 0 && riskPercent > 0 && leverage > 0) {\n            const pos = calcPositionSize({\n                equity,\n                riskPercent,\n                leverage,\n                entryPrice,\n                stopLossPrice\n            });\n\n            if (pos) {\n                setResultState({\n                    ...baseResult,\n                    riskAmount: pos.riskAmount.toFixed(2),\n                    positionNotional: pos.finalNotional.toFixed(2),\n                    positionQty: pos.qty.toFixed(4)\n                });\n                return;\n            }\n        }\n\n        setResultState(baseResult);\n    } catch (err) {\n        console.error('请求K线失败', err);\n        setError('请求现货K线失败（请确认 api.binance.com 合法域名已配置）');\n    }\n};\n\nonLoad(() => {\n    refreshPrices();\n});\n\nconst {\n    symbolOptions,\n    symbol,\n    intervalOptions,\n    interval,\n    atrPeriodInput,\n    atrMultInput,\n    equityInput,\n    riskPercentInput,\n    leverageInput,\n    entryPriceInput,\n    directionOptions,\n    direction,\n    spotPrice,\n    futuresPrice,\n    priceDiff,\n    loading,\n    atr,\n    stopLossPrice,\n    error,\n    rrRatio,\n    riskAmount,\n    stopDistance,\n    positionNotional,\n    positionQty\n} = toRefs(state);\n</script>\n<style>\n/* 可以加一点页面级的小调整 */\n.container {\n    /* 可选：稍微窄一点，看起来更像工具面板 */\n    max-width: 680rpx;\n    margin: 0 auto;\n}\n\n/* 给结果卡片一点额外的间距，方便观察 */\n.result-card-wrapper {\n    margin-top: 24rpx;\n}\n</style>\n","import MiniProgramPage from '/Users/quanshunzhi/WeChatProjects/atr-risk-miniapp_uni/pages/index/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["reactive","SYMBOL_OPTIONS","INTERVAL_OPTIONS","symbol","fetchSpotPrice","fetchFuturesPrice","uni","atrPeriodInput","atrMultInput","entryPriceInput","direction","interval","equityInput","riskPercentInput","leverageInput","fetchCandlesFromBinance","atr","calcATR","stopLossPrice","calcPositionSize","onLoad","toRefs","MiniProgramPage"],"mappings":"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"}